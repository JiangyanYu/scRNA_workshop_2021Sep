---
title: "R Notebook"
output: html_notebook


---

# preparation work

## load scRNA data into docker

1. Download toy data from here: https://cf.10xgenomics.com/samples/cell/pbmc3k/pbmc3k_filtered_gene_bc_matrices.tar.gz

2. Upload the data into rstudio
 barcodes.tsv
 genes.tsv
 matrix.mtx
 
```{r}
# make a new folder for data
dir.create(path = "/home/jyu/scRNA/data")

# upload scRNA files into "/home/jyu/scRNA/data"
```

## library

```{r}
library(Seurat)
library(dplyr)
library(magrittr)
library(ggplot2)
```

## working directory

```{r}
counts_dir = "/home/jyu/scRNA/data"
working_dir = "/home/jyu/scRNA"
```

# QC

## load PBMC data into seurat 

```{r}
# Load the PBMC dataset
pbmc.data <- Read10X(data.dir = counts_dir)

# Initialize the Seurat object with the raw (non-normalized data).
pbmc <- CreateSeuratObject(counts = pbmc.data, 
                           project = "scRNA_workshop_2021Sep", 
                           min.cells = 3, 
                           min.features = 200)

# seurat object
pbmc

# check pbmc in Environment on the right sidebar
```

## quality parameters

```{r}
# mt percent
pbmc[["percent.mt"]] <- PercentageFeatureSet(pbmc, pattern = "^MT-")

# Visualize QC metrics as a violin plot
VlnPlot(pbmc, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)+theme(legend.position = "none")

# Visualize QC matrics on scatterplot
plot1 <- FeatureScatter(pbmc, feature1 = "nCount_RNA", feature2 = "percent.mt")+theme(legend.position = "none")
plot2 <- FeatureScatter(pbmc, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")+theme(legend.position = "none")
plot1 + plot2


```

## filtering {.tabset .tabset-fade}

### mt% 

```{r}
plot1 + 
  geom_hline(yintercept = 5) + 
  geom_text(x=10000, y=7, label = "mt%>5%: dead cells")
```

### nFeature_RNA

```{r}
plot2+ 
  geom_hline(yintercept = 2500) + 
  geom_text(x=10000, y=2700, label = "Doublets") +
  geom_hline(yintercept = 200) + 
  geom_text(x=10000, y=100, label = "Low quality cells")
  
```

## remove unwanted cells

```{r}
pbmc <- subset(pbmc, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mt < 5)
```

# normalization and scaling

preparation for PCA and umap

## normalization

```{r}
pbmc <- NormalizeData(pbmc, normalization.method = "LogNormalize", scale.factor = 10000)

## only focus on highly variable features
pbmc <- FindVariableFeatures(pbmc, selection.method = "vst", nfeatures = 2000)

# Identify the 10 most highly variable genes
top10 <- head(VariableFeatures(pbmc), 10)

# plot variable features with and without labels
plot1 <- VariableFeaturePlot(pbmc)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE)
plot1 + plot2
```

## scaling

```{r}
all.genes <- rownames(pbmc)
pbmc <- ScaleData(pbmc, features = all.genes)
```

# PCA

